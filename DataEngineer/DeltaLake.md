💡 델타 레이크는 아파치 스파크의 창시자가 구축한 리눅스 파운데이션에서 호스팅하는 오픈소스 프로젝트이다.

델타 레이크는 다음을 지원한다.

- 정형화 스트리밍 소스 및 싱크를 사용하여 테이블에서 스트리밍 읽기 및 쓰기
- 자바, 스칼라 및 파이썬 API에서도 업데이트, 삭제 및 병합(Upsert) 작업
- 테이블 스키마를 명시적으로 변경하거나 데이터 프레임의 쓰기 중에도 데이터프레임의 스키마를 테이블의 스키마에 암시적으로 병합하여 스키마를 변경 가능
- ID 또는 타임스탬프별로 특정 테이블 스냅샷을 쿼리할 수 있는 시간 탐색 기능
- 오류를 수정하기 위한 이전 버전으로의 롤백 기능
- SQL, 배치 처리 또는 스트리밍 작업을 수행하는 여러 동시 작성기 간의 직렬화 가능한 격리

## 이 페이지에서 설명하는 Delta Lake의 사용법 목차

- 스파크를 사용하여 델타 레이크 테이블 읽기 및 쓰기
- 델타 레이크에서 ACID 보장으로 동시 배치 처리 및 스트리밍 쓰기를 허용하는 방법
- 델타 레이크가 모든 쓰기에 스키마를 적용하고 명시적 스키마 진화를 허용하여 더 나은 데이터 품질을 보장하는 방법
- 업데이트, 삭제 및 병합 작업을 사용하여 복잡한 데이터 파이프라인 구축
- 델타 레이크 테이블을 수정한 작업 기록을 감사하고, 이전 버전의 테이블을 쿼리하여 과거로 여행하는 법

### 델타 레이크 테이블에 데이터 로드

델타 레이크에는 JSON, Parquet, ORC와 같은 기존 형식에 비해 몇 가지 추가 이점이 있다.

- 배치 처리 및 스트리밍 작업 모두에서 동일한 테이블에 쓰기 가능

    기존의 다른 형식들을 사용하면 정형화 스트리밍 작업에서 테이블에 작성된 데이터가 테이블의 기존 데이터를 덮어쓴다. 스트리밍 쓰기에 대해서 일회 처리 보장을 위해 테이블에 관리되는 메타데이터는 다른 비스트리밍 쓰기를 고려하지 않기 때문이다. 델타 레이크의 진보된 메타데이터 관리는 배치 및 스트리밍 데이터를 모두 작성할 수 있게 한다.

- 여러 스트리밍 작업에서 동일한 테이블에 데이터 추가 가능

    다른 형식의 메타데이터의 한계점은 여러 정형화 스트리밍 쿼리가 동일한 테이블에 추가되는 것을 막는다. 그러나 델타 레이크의 메타데이터는 각 스트리밍 쿼리에 대한 트랜잭션 정보를 유지하므로 원하는 수의 스트리밍 쿼리가 일회 처리 보장되는 테이블에도 동시에 쓸 수 있다.

- 동시 쓰기에도 ACID 보장

    기존의 다른 형식들과 달리 델타 레이크는 동시 배치 및 스트리밍 작업이 ACID 보장으로 데이터를 쓸 수 있게 한다.

### 데이터 손상을 방지하기 위해 쓰기 시 스키마 적용

파케이 파일은 전체 테이블에 대한 일관성을 보장하지 않는다. 반면 델타 레이크는 스키마를 테이블 수준 메타데이터로 기록한다. 따라서 델타 레이크 테이블에 대한 모든 쓰기는 기록 중인 데이터에 테이블의 스키마와 호환되는 스키마가 있는지 여부를 확인할 수 있다. 호환되지 않는 경우, 스파크는 데이터가 기록되고 테이블에 커밋되기 전에 오류를 발생시켜 이러한 우발적 데이터 손상을 방지한다.

그러나 `mergeSchema` 옵션을 사용하면 기존에 저장된 데이터 테이블의 스키마를 새로운 데이터와 merge 할 수 있는 방법 또한 제공한다.

### 기존 데이터 변환

델타 레이크는 복잡한 데이터 파이프라인을 구축할 수 있는 DML 명령 UPDATE, DELETE 및 MERGE를 지원한다. 이러한 명령은 자바, 스칼라, 파이썬 및 SQL을 사용하여 호출할 수 있으므로 사용자는 데이터프레임 또는 테이블을 사용하여 익숙한 API와 함께 명령을 유연하게 사용할 수 있다. 또한 이러한 각 데이터 수정 작업은 ACID를 보장한다.

### 오류 수정을 위한 데이터 업데이트(to be continue…)

### Table History 보기

```jsx
DESCRIBE HISTORY '/data/events/'          -- get the full history of the table

DESCRIBE HISTORY delta.`/data/events/`

DESCRIBE HISTORY '/data/events/' LIMIT 1  -- get the last operation only

DESCRIBE HISTORY eventsTable

+-------+-------------------+------+--------+---------+--------------------+----+--------+---------+-----------+-----------------+-------------+--------------------+
|version|          timestamp|userId|userName|operation| operationParameters| job|notebook|clusterId|readVersion|   isolationLevel|isBlindAppend|    operationMetrics|
+-------+-------------------+------+--------+---------+--------------------+----+--------+---------+-----------+-----------------+-------------+--------------------+
|      5|2019-07-29 14:07:47|   ###|     ###|   DELETE|[predicate -> ["(...|null|     ###|      ###|          4|WriteSerializable|        false|[numTotalRows -> ...|
|      4|2019-07-29 14:07:41|   ###|     ###|   UPDATE|[predicate -> (id...|null|     ###|      ###|          3|WriteSerializable|        false|[numTotalRows -> ...|
|      3|2019-07-29 14:07:29|   ###|     ###|   DELETE|[predicate -> ["(...|null|     ###|      ###|          2|WriteSerializable|        false|[numTotalRows -> ...|
|      2|2019-07-29 14:06:56|   ###|     ###|   UPDATE|[predicate -> (id...|null|     ###|      ###|          1|WriteSerializable|        false|[numTotalRows -> ...|
|      1|2019-07-29 14:04:31|   ###|     ###|   DELETE|[predicate -> ["(...|null|     ###|      ###|          0|WriteSerializable|        false|[numTotalRows -> ...|
|      0|2019-07-29 14:01:40|   ###|     ###|    WRITE|[mode -> ErrorIfE...|null|     ###|      ###|       null|WriteSerializable|         true|[numFiles -> 2, n...|
+-------+-------------------+------+--------+---------+--------------------+----+--------+---------+-----------+-----------------+-------------+--------------------+
```

### 여담

- Delta Lake의 이름 유래:

    시냇물(stream)은 삼각주(delta)를 만들며 바다로 흘러들어간다. 그곳에서 모든 퇴적물이 축적되어 귀중한 작물이 재배된다. - Jules S. Damji(공동 저자 중 한 명) -

### References

------

history: https://docs.databricks.com/delta/history.html