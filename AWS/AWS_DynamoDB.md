# AWS DynamoDB

DynamoDB는 모든 규모에서 고성능 애플리케이션을 실행하도록 설계된 완전관리형 서버리스 Key-Value NoSQL DB이다.

DynamoDB가 제공하는 기능은 다음과 같다.

- 기본 제공 보안
- 지속적인 백업
- 자동화된 다중 리전 복제
- 인 메모리 캐시 및 데이터 가져오기/내보내기 도구 제공



### 핵심 구성 요소(Table > Items > Attributes)

- Table: dynamodb에서 가장 큰 집합으로, 여타 데이터베이스와 같다고 생각하면 된다.
- Items: 모든 다른 항목들 중에서 고유하게 식별할 수 있는 속성들의 집합이다. 다이나모디비에서는 테이블에 저장하는 항목의 수는 제한이 없다.
- Attributes: 각 Items는 하나 이상의 Attributes로 구성된다.



### 키 종류

- Partition Key:

    - RDB에서 Primary와 같은 역할을 한다.
    - 테이블에 하나만 존재할 수 있으며, 값으로 아이템을 어디에 나눌지 정한다.
    - 물리적 공간인 파티션을 특정하는 키다.
        - 스케일이 아무리 커져도 주소를 알고 있어서 빠르게 가져올 수 있다.
    - 해시 키라고도 할 수 있다(내부적으로 해시함수를 사용함).
    - 어떤 테이블이 파티션 키로만 구성되어 있다면 각 항목은 이 파티션 키 하나만으로 식별할 수 있다.
    - 파티션키의 해시값을 이용해 저장할 파티션을 결정한다.
    - DynamoDB는 Parition의 크기가 10G를 초과하거나, Provisioning Throughput이 일정 수준 이상이 되면 데이터에 대한 Partition을 나눈다. 이때 파티션을 나누는 기준은 파티션키가 된다. 파티션키가 같은 데이터가 같은 파티션에 저장되는 것이다.
    - 일치방식(Equal)의 검색만 지원한다.

- Sort Key:

    - 파티션 내에서 정렬되는 기준 값이다. 같은 파티션 내에서 정렬키를 기준으로 정렬된다.
    - 일치방식의 검색만 지원하는 파티션키와는 달리 일치, 부등호, 포함 등의 범위를 지정할 수 있는 검색을 지원한다.
    - 정렬키를 신중하게 설계하면 begins_with, between, >, < 등의 연산자로 범위 쿼리를 통해 필요한 항목의 그룹을 검색할 수 있다.

    

### 데이터 형식

| Type       | PartiQL 표현            | 참고                                                         |
| ---------- | ----------------------- | ------------------------------------------------------------ |
| Boolean    | TRUE                    | FALSE                                                        |
| Binary     | 해당 사항 없음          | 코드를 통해서만 지원됩니다.                                  |
| List       | [value1, value2, …]     | 목록 형식에 저장할 수 있는 데이터 형식에는 제한이 없으며, 목록에 있는 요소의 형식이 달라도 상관 없습니다. |
| Map        | {’key’: value}          | 맵 형식에 저장할 수 있는 데이터 형식에는 제한이 없으며, 맵에 있는 요소의 ㅎ여식이 달라도 상관없습니다. |
| Null       | NULL                    | 대/소문자를 구문하지 않습니다.                               |
| Number     | 1, 1.0, 1e0             | 번호는 양수, 음수 또는 0일 수 있습니다. 숫자는 최대 38자릿수까지 지원됩니다. |
| Number Set | <<number1, number2>>    | 숫자 집합의 요소는 숫자 형식어어야 합니다.                   |
| String Set | <<’string1, ‘string2’>> | 문자열 집합의 요소는 문자열 형식이어야 합니다.               |
| String     | ‘string value’          | 작은 따옴표를 사용하여 문자열 값을 지정해야 합니다.          |



### 조회 동작 구조

Input이 들어오면 해당 Input에 맞는 해당하는 파티션키의 값을 반환하고, 해당 파티션에 정렬키가 있다면 정렬키로 특정 범위를 조회한다.



### 비용

DynamoDB에는 두 가지의 과금 체계가 있다.

- Provisioned
    - RCU와 WCU를 직접 설정하는데, ‘초당 처리량’에 기준을 둔다.
    - 예약 요금은 프로비저닝 모드에서 쓸 RCU와 WCU를 미리 사두는 개념이다.
- On-demand
    - 사용한 RCU와 WCU만큼 과금하는 모델이다.
    - 사용한 만큼 과금되기 때문에 처리량의 한계와 핫파티션 이슈가 없다.
    - 프로비저닝 모드보다 더 비싸다. 비용 절감을 위해 서비스가 안정화되면 프로비저닝 모드로의 전환이 필요하다.



### 비용 관련 용어

------

- RCU(Read Capacity Unit): 테이블에 데이터 읽기 API를 호출하여 읽기 기능을 수행한다. 읽기 요청은 세 가지로 구분된다.

    1. 강력한 일관된 읽기(Strongly consistent read):

        최대 4KB 크기 항목의 경우 RCU 1개가 초당 1회의 요청을 수행할 수 있다. 4KB보다 큰 항목의 경우 추가 RCU가 필요하다.

    2. 최종적 일관된 읽기(Eventually consistent read):

        최대 4KB 크기 항목의 경우 RCU 1개가 초당 2회의 요청을 수행할 수 있다.

    3. 트랜잭션 읽기(Transactional read):

        최대 4KB 크기 항목의 경우 초당 1회의 요청을 수행하는 데 2개의 RCU가 필요하다.

    - 읽기 요청 예시:
        - 요청 데이터 크기: 8KB
        - 읽기 요청 구분에 따른 RCU 갯수
            - 강력한 일관된 읽기: 2개의 RCU
            - 최종적 읽관된 읽기: 1개의 RCU
            - 트랜잭션 읽기: 4개의 RCU

- WCU(Write Capacity Unit): 테이블에 데이터 쓰기 API를 호출하여 쓰기 기능을 수행한다.

    1. 표준 쓰기:

        최대 1KB 크기 항목의 경우 1개의 WCU가 초당 1회의 표준 쓰기 요청을 수행할 수 있다. 1KB 보다 큰 항목의 경우 추가 WCU가 필요하다.

    2. 트랜잭션 쓰기:

        최대 1KB 크기 항목의 초당 1회 쓰기를 수행하는 데 2개의 WCU가 필요하다.

    - 쓰기 요청 예시:
        - 요청 데이터 크기: 3KB
        - 읽기 요청 구분에 따른 WCU 갯수
            - 표준 쓰기: 3개의 WCU
            - 트랜잭션 쓰기: 6개의 WCU

- 트랜잭션 읽기/쓰기 요청: DynamoDB에서 트랜잭션 읽기 또는 쓰기는 표준 읽기 또는 쓰기와 다르다. **단일 트랜잭션에 포함된 모든 작업이 하나처럼 성공 또는 실패로 설정되도록 보장**하기 때문이다.

그 외 rWCU(복제된 쓰기 용량 유닛), 스트림 읽기 요청 유닛, 변경 데이터 캡처 유닛, DynamoDB 테이블 클래스가 있으나 추후 필요할 경우 정리하기로 한다.



### GSI(Global Secondary Index)

테이블에 보조 인덱스인 GSI를 만들면 아이템을 조회하기 위한 또 다른 PK와 SK를 추가할 수 있다.

GSI를 추가하면 원본 테이블을 복제해 새로운 테이블을 만드는 방식이다.

1. GSI의 파티션 키로 새로운 물리 공간을 할당 후 저장
2. GSI의 정렬 키를 기준으로 정렬하여 저장
3. 원본 테이블이 변경되면 GSI 테이블도 동기화됨

원본 테이블과 마찬가지로 GSI도 파티션 키와 정렬 키로 특정 공간에 정렬되어 있어 원본 테이블과 동일한 성능 수준으로 조회할 수 있다.